{% extends 'base.html' %}
{% block content %}
<style>
  .new-booking-page {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #2c3e50;
    line-height: 1.6;
  }

  .booking-step {
    display: none;
  }

  .booking-step.active {
    display: block;
  }

  .step-indicator {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    position: relative;
  }

  .step-indicator::before {
    content: '';
    position: absolute;
    top: 15px;
    left: 0;
    right: 0;
    height: 2px;
    background-color: #e9ecef;
    z-index: 1;
  }

  .step {
    position: relative;
    z-index: 2;
    text-align: center;
    flex: 1;
  }

  .step-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.5rem;
    font-weight: bold;
    border: 2px solid #e9ecef;
  }

  .step.active .step-circle {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
  }

  .step.completed .step-circle {
    background-color: #28a745;
    color: white;
    border-color: #28a745;
  }

  .step-label {
    font-size: 0.875rem;
    color: #6c757d;
  }

  .step.active .step-label {
    color: #0d6efd;
    font-weight: 600;
  }

  .step.completed .step-label {
    color: #28a745;
  }

  .booking-card {
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    margin-bottom: 1.5rem;
    border: none;
  }

  .booking-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
  }

  .booking-card .card-header {
    background: linear-gradient(135deg, #0d6efd, #0b5ed7);
    color: white;
    border-radius: 15px 15px 0 0 !important;
    border: none;
  }

  .booking-form .form-label {
    font-weight: 600;
    color: #2c3e50;
  }

  .booking-form .form-control, 
  .booking-form .form-select {
    border-radius: 8px;
    padding: 0.75rem 1rem;
    border: 1px solid #dee2e6;
  }

  .booking-form .form-control:focus, 
  .booking-form .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }

  .booking-form .input-group-text {
    background-color: #e7f1ff;
    border: 1px solid #dee2e6;
    border-right: none;
    border-radius: 8px 0 0 8px;
  }

  .booking-form .form-control {
    border-left: none;
    border-radius: 0 8px 8px 0;
  }

  .btn-nav {
    border-radius: 10px;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s ease;
  }

  .btn-nav:hover {
    transform: translateY(-2px);
  }

  .btn-prev {
    background-color: #6c757d;
    border: 1px solid #6c757d;
    color: white;
  }

  .btn-prev:hover {
    background-color: #5a6268;
    border-color: #545b62;
  }

  .btn-next {
    background: linear-gradient(135deg, #0d6efd, #0b5ed7);
    border: none;
    color: white;
  }

  .btn-next:hover {
    background: linear-gradient(135deg, #0b5ed7, #0d6efd);
    box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
  }

  .btn-submit {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    color: white;
  }

  .btn-submit:hover {
    background: linear-gradient(135deg, #20c997, #28a745);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
  }

  .hospital-card {
    border-radius: 12px;
    border: none;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .hospital-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
  }

  .hospital-card.selected {
    border: 2px solid #0d6efd;
    box-shadow: 0 5px 15px rgba(13, 110, 253, 0.2);
  }

  .room-option {
    border-radius: 10px;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .room-option:hover {
    border-color: #0d6efd;
    background-color: #f8f9fa;
  }

  .room-option.selected {
    border-color: #0d6efd;
    background-color: #e7f1ff;
  }

  .price-tag {
    background: linear-gradient(135deg, #0d6efd, #0b5ed7);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .section-title i {
    color: #0d6efd;
  }

  .section-title h1 {
    color: #2c3e50;
    font-weight: 700;
  }

  .card-title {
    color: #2c3e50;
    font-weight: 600;
  }

  .form-text {
    color: #6c757d;
  }

  @media (max-width: 768px) {
    .new-booking-page {
      padding: 1rem;
    }
    
    .booking-card {
      margin-bottom: 1rem;
    }
    
    .booking-form .form-control, 
    .booking-form .form-select {
      padding: 0.5rem 0.75rem;
    }
    
    .step-indicator::before {
      top: 12px;
    }
    
    .step-circle {
      width: 24px;
      height: 24px;
      font-size: 0.75rem;
    }
  }
</style>

<div class="container py-5 new-booking-page">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="section-title mb-4 text-center">
        <i class="bi bi-calendar-check display-5 mb-3"></i>
        <h1 class="h2 mb-0">Medical Travel Booking</h1>
      </div>
      
      <p class="mb-4 text-center lead">Complete your medical travel arrangements in simple steps</p>
      
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step active" data-step="1">
          <div class="step-circle">1</div>
          <div class="step-label">Treatment</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-circle">2</div>
          <div class="step-label">Doctor</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-circle">3</div>
          <div class="step-label">Hospitals</div>
        </div>
        <div class="step" data-step="4">
          <div class="step-circle">4</div>
          <div class="step-label">Room</div>
        </div>
        <div class="step" data-step="5">
          <div class="step-circle">5</div>
          <div class="step-label">Booking</div>
        </div>
      </div>
      
      <div class="card border-0 shadow-sm booking-card">
        <div class="card-body">
          <form id="newBookingForm" class="booking-form" method="POST" onsubmit="console.log('Form is being submitted'); return true;">
            {% csrf_token %}
            
            <!-- Step 1: Treatment Selection -->
            <div class="booking-step active" id="step-1">
              <h5 class="card-title mb-4">Step 1: Select Treatment</h5>
              
              <div class="mb-4">
                <label class="form-label fw-semibold">Type of Treatment <span class="text-danger">*</span></label>
                <select class="form-select form-control-lg" id="treatmentSelect" name="treatment" required>
                  <option value="">Select Treatment</option>
                  {% for treatment in treatments %}
                  <option value="{{ treatment.id }}" {% if selected_treatment and selected_treatment.id == treatment.id %}selected{% endif %}>{{ treatment.name }}</option>
                  {% endfor %}
                </select>
                <div class="form-text">Choose the medical treatment you're interested in</div>
              </div>
              
              <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-next" id="nextStep1">
                  <i class="bi bi-arrow-right me-2"></i>Next: Select Doctor (Optional)
                </button>
              </div>
            </div>
            
            <!-- Step 2: Doctor Selection (Optional) -->
            <div class="booking-step" id="step-2">
              <h5 class="card-title mb-4">Step 2: Select Doctor (Optional)</h5>
              
              <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Doctor Selection is Optional</strong>
                <p class="mb-0 mt-2">You can select a specific doctor for your treatment, or we can recommend the best doctor based on your selected hospital. If you're unsure, you can skip this step.</p>
              </div>
              
              <div class="mb-4">
                <label class="form-label fw-semibold">Preferred Doctor</label>
                <select class="form-select form-control-lg" id="doctorSelect" name="preferred_doctor">
                  <option value="">No preference (we'll recommend)</option>
                  <!-- Doctors will be populated dynamically based on selected treatment -->
                </select>
                <div class="form-text">Select a specific doctor or leave blank for our recommendation</div>
              </div>
              
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-prev" id="prevStep2">
                  <i class="bi bi-arrow-left me-2"></i>Back
                </button>
                <button type="button" class="btn btn-next" id="nextStep2">
                  <i class="bi bi-arrow-right me-2"></i>Next: View Hospitals
                </button>
              </div>
            </div>
            
            <!-- Step 3: Hospital Selection with Pricing -->
            <div class="booking-step" id="step-3">
              <h5 class="card-title mb-4">Step 3: Select Hospital</h5>
              
              <div class="mb-4">
                <label class="form-label fw-semibold">Preferred Booking Dates</label>
                <input type="date" class="form-control form-control-lg" id="preferredDate" name="preferred_date" min="{% now "Y-m-d" %}">
                <div class="form-text">Select your preferred date for the treatment</div>
              </div>
              
              <div class="mb-4">
                <h6 class="mb-3">Hospitals Offering This Treatment</h6>
                <div id="hospitalsList" class="row g-3">
                  <!-- Hospitals will be populated dynamically -->
                  <div class="col-12 text-center py-5">
                    <div class="text-muted">Please select a treatment and doctor first</div>
                  </div>
                </div>
              </div>
              
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-prev" id="prevStep3">
                  <i class="bi bi-arrow-left me-2"></i>Back
                </button>
                <button type="button" class="btn btn-next" id="nextStep3" disabled>
                  <i class="bi bi-arrow-right me-2"></i>Next: Select Room
                </button>
              </div>
            </div>
            
            <!-- Step 4: Room Selection with Pricing -->
            <div class="booking-step" id="step-4">
              <h5 class="card-title mb-4">Step 4: Select Room</h5>
              
              <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Room Selection</strong>
                <p class="mb-0 mt-2">Select your preferred room type for your hospital stay. The cost includes 7 nights by default, but you can adjust this based on your treatment duration.</p>
              </div>
              
              <div class="mb-4">
                <h6 class="mb-3">Selected Hospital: <span id="selectedHospitalName" class="text-primary"></span></h6>
                <div class="alert alert-info">
                  <i class="bi bi-info-circle me-2"></i>Estimated treatment cost: <span id="treatmentCost" class="fw-bold"></span>
                </div>
              </div>
              
              <div class="mb-4">
                <h6 class="mb-3">Room Options</h6>
                <div class="alert alert-warning mb-3">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <strong>Note:</strong> The room cost shown is per night. The total room cost will be calculated based on a 7-night stay, which is the average duration for most treatments.
                </div>
                <div id="roomOptions" class="row g-3">
                  <!-- Room options will be populated dynamically -->
                  <div class="col-12 text-center py-5">
                    <div class="text-muted">Please select a hospital first</div>
                  </div>
                </div>
              </div>
              
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-prev" id="prevStep4">
                  <i class="bi bi-arrow-left me-2"></i>Back
                </button>
                <button type="button" class="btn btn-next" id="nextStep4" disabled>
                  <i class="bi bi-arrow-right me-2"></i>Next: Confirm Booking
                </button>
              </div>
            </div>
            
            <!-- Step 5: Booking Confirmation -->
            <div class="booking-step" id="step-5">
              <h5 class="card-title mb-4">Step 5: Confirm Booking</h5>
              
              <div class="mb-4">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <h6 class="card-title mb-3">Booking Summary</h6>
                    <ul class="list-unstyled mb-0">
                      <li class="mb-2"><i class="bi bi-chevron-right text-primary me-2"></i><strong>Treatment:</strong> <span id="summaryTreatment"></span></li>
                      <li class="mb-2"><i class="bi bi-chevron-right text-primary me-2"></i><strong>Doctor:</strong> <span id="summaryDoctor">Not specified</span></li>
                      <li class="mb-2"><i class="bi bi-chevron-right text-primary me-2"></i><strong>Hospital:</strong> <span id="summaryHospital"></span></li>
                      <li class="mb-2"><i class="bi bi-chevron-right text-primary me-2"></i><strong>Room Type:</strong> <span id="summaryRoom"></span></li>
                      <li class="mb-2"><i class="bi bi-chevron-right text-primary me-2"></i><strong>Preferred Date:</strong> <span id="summaryDate"></span></li>
                      <li class="mb-2"><i class="bi bi-chevron-right text-primary me-2"></i><strong>Treatment Cost:</strong> <span id="treatmentCostSummary">₹0</span></li>
                      <li class="mb-2"><i class="bi bi-chevron-right text-primary me-2"></i><strong>Room Cost (7 nights):</strong> <span id="roomCostSummary">₹0</span></li>
                      <li class="border-top pt-2 mt-2"><i class="bi bi-chevron-right text-primary me-2"></i><strong>Total Cost:</strong> <span id="summaryCost" class="h5 text-primary"></span></li>
                    </ul>
                  </div>
                </div>
              </div>
              
              <div class="mb-4">
                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <strong>Advance Payment Required</strong>
                  <p class="mb-0 mt-2">A small advance payment of <span id="advanceAmount" class="fw-bold"></span> is required to confirm your booking and secure your preferred dates.</p>
                </div>
              </div>
              
              <div class="mb-4">
                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" id="termsCheck" name="agree_terms" required>
                  <label class="form-check-label" for="termsCheck">
                    I agree to the <a href="{% url 'terms' %}" class="text-decoration-none">Terms of Service</a> and <a href="{% url 'privacy' %}" class="text-decoration-none">Privacy Policy</a> <span class="text-danger">*</span>
                  </label>
                </div>
              </div>
              
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-prev" id="prevStep5">
                  <i class="bi bi-arrow-left me-2"></i>Back
                </button>
                <button type="submit" class="btn btn-submit" id="submitBooking">
                  <i class="bi bi-credit-card me-2"></i>Pay Advance & Confirm Booking
                </button>
              </div>
            </div>
            
            <!-- Hidden fields to store selected values -->
            <input type="hidden" id="selectedTreatmentId" name="treatment_id">
            <input type="hidden" id="selectedDoctorId" name="doctor_id">
            <input type="hidden" id="selectedHospitalId" name="hospital_id">
            <input type="hidden" id="selectedRoomId" name="room_id">
            <input type="hidden" id="totalAmount" name="total_amount">
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Global variables to store selections
  let selectedTreatmentId = null;
  let selectedDoctorId = null;
  let selectedHospitalId = null;
  let selectedRoomId = null;
  let selectedTreatmentName = '';
  let selectedDoctorName = '';
  let selectedHospitalName = '';
  let selectedRoomName = '';
  let treatmentCost = 0;
  let roomCost = 0;
  let totalCost = 0;
  
  // DOM elements
  const steps = document.querySelectorAll('.booking-step');
  const stepIndicators = document.querySelectorAll('.step');
  const nextStep1 = document.getElementById('nextStep1');
  const prevStep2 = document.getElementById('prevStep2');
  const nextStep2 = document.getElementById('nextStep2');
  const prevStep3 = document.getElementById('prevStep3');
  const nextStep3 = document.getElementById('nextStep3');
  const prevStep4 = document.getElementById('prevStep4');
  const nextStep4 = document.getElementById('nextStep4');
  const prevStep5 = document.getElementById('prevStep5');
  const treatmentSelect = document.getElementById('treatmentSelect');
  const doctorSelect = document.getElementById('doctorSelect');
  const hospitalsList = document.getElementById('hospitalsList');
  const roomOptions = document.getElementById('roomOptions');
  const preferredDate = document.getElementById('preferredDate');
  
  // Set minimum date to today
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    preferredDate.min = today;
    
    // Initialize selectedTreatmentId from the select element
    selectedTreatmentId = treatmentSelect.value || null;
    
    // If a treatment is pre-selected, automatically proceed to step 2
    if (selectedTreatmentId) {
      // Get treatment name
      const selectedOption = treatmentSelect.options[treatmentSelect.selectedIndex];
      selectedTreatmentName = selectedOption.text;
      
      // Populate doctors based on selected treatment
      populateDoctors(selectedTreatmentId);
      
      // Get treatment pricing information
      getTreatmentPricing(selectedTreatmentId);
      
      // Show step 2
      showStep(2);
    }
    
    // Handle medical documents file input
    const medicalDocumentsInput = document.getElementById('medicalDocumentsInput');
    const medicalDocumentsDropArea = document.getElementById('medicalDocumentsDropArea');
    const medicalDocumentsList = document.getElementById('medicalDocumentsList');
    
    // Handle file selection
    medicalDocumentsInput.addEventListener('change', function(e) {
      updateFileList(e.target.files, medicalDocumentsList);
    });
    
    // Handle drag and drop
    medicalDocumentsDropArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      medicalDocumentsDropArea.classList.add('dragover');
    });
    
    medicalDocumentsDropArea.addEventListener('dragleave', function(e) {
      medicalDocumentsDropArea.classList.remove('dragover');
    });
    
    medicalDocumentsDropArea.addEventListener('drop', function(e) {
      e.preventDefault();
      medicalDocumentsDropArea.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        medicalDocumentsInput.files = e.dataTransfer.files;
        updateFileList(e.dataTransfer.files, medicalDocumentsList);
      }
    });
    
    // Handle click on drop area
    medicalDocumentsDropArea.addEventListener('click', function() {
      medicalDocumentsInput.click();
    });
    
    // Function to update file list display
    function updateFileList(files, fileListElement) {
      fileListElement.innerHTML = '';
      if (files.length > 0) {
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
            <span class="file-name">${file.name}</span>
            <span class="file-size text-muted small">${formatFileSize(file.size)}</span>
            <span class="file-remove" data-index="${i}">×</span>
          `;
          fileListElement.appendChild(fileItem);
        }
        
        // Add event listeners to remove buttons
        document.querySelectorAll('.file-remove').forEach(button => {
          button.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            removeFile(index);
          });
        });
      }
    }
    
    // Function to format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Function to remove a file from the list
    function removeFile(index) {
      const dt = new DataTransfer();
      const files = medicalDocumentsInput.files;
      
      for (let i = 0; i < files.length; i++) {
        if (i !== index) {
          dt.items.add(files[i]);
        }
      }
      
      medicalDocumentsInput.files = dt.files;
      updateFileList(dt.files, medicalDocumentsList);
    }
  });
  
  // Step navigation functions
  function showStep(stepNumber) {
    // Hide all steps
    steps.forEach(step => step.classList.remove('active'));
    
    // Show current step
    document.getElementById(`step-${stepNumber}`).classList.add('active');
    
    // Update step indicators
    stepIndicators.forEach((indicator, index) => {
      indicator.classList.remove('active', 'completed');
      if (index + 1 < stepNumber) {
        indicator.classList.add('completed');
      } else if (index + 1 === stepNumber) {
        indicator.classList.add('active');
      }
    });
  }
  
  // Event listeners for navigation
  nextStep1.addEventListener('click', function() {
    selectedTreatmentId = treatmentSelect.value;
    if (!selectedTreatmentId) {
      alert('Please select a treatment');
      return;
    }
    
    // Get treatment name
    const selectedOption = treatmentSelect.options[treatmentSelect.selectedIndex];
    selectedTreatmentName = selectedOption.text;
    
    // Update hidden form field
    document.getElementById('selectedTreatmentId').value = selectedTreatmentId;
    
    // Populate doctors based on selected treatment
    populateDoctors(selectedTreatmentId);
    
    // Get treatment pricing information
    getTreatmentPricing(selectedTreatmentId);
    
    showStep(2);
  });
  
  prevStep2.addEventListener('click', function() {
    showStep(1);
  });
  
  nextStep2.addEventListener('click', function() {
    selectedDoctorId = doctorSelect.value || null;
    
    // Get doctor name if selected
    if (selectedDoctorId) {
      const selectedOption = doctorSelect.options[doctorSelect.selectedIndex];
      selectedDoctorName = selectedOption.text;
      
      // Get doctor pricing information if hospital is already selected
      if (selectedHospitalId) {
        getDoctorPricing(selectedDoctorId, selectedTreatmentId, selectedHospitalId);
      }
    } else {
      selectedDoctorName = 'Not specified';
    }
    
    // Update hidden form field
    document.getElementById('selectedDoctorId').value = selectedDoctorId || '';
    
    // Populate hospitals based on treatment and doctor
    populateHospitals(selectedTreatmentId, selectedDoctorId);
    
    showStep(3);
  });
  
  prevStep3.addEventListener('click', function() {
    showStep(2);
  });
  
  nextStep3.addEventListener('click', function() {
    if (!selectedHospitalId) {
      alert('Please select a hospital');
      return;
    }
    
    // Get doctor pricing information if doctor is selected
    if (selectedDoctorId) {
      getDoctorPricing(selectedDoctorId, selectedTreatmentId, selectedHospitalId);
    }
    
    // Populate room options based on selected hospital
    populateRoomOptions(selectedHospitalId);
    
    // Update summary information
    document.getElementById('selectedHospitalName').textContent = selectedHospitalName;
    document.getElementById('treatmentCost').textContent = `₹${treatmentCost.toLocaleString()}`;
    
    showStep(4);
  });
  
  prevStep4.addEventListener('click', function() {
    showStep(3);
  });
  
  nextStep4.addEventListener('click', function() {
    if (!selectedRoomId) {
      alert('Please select a room option');
      return;
    }
    
    // Calculate total cost (treatment cost + 7 nights room cost)
    const roomCostFor7Nights = roomCost * 7;
    totalCost = treatmentCost + roomCostFor7Nights;
    const advanceAmount = totalCost * 0.1; // 10% advance
    
    // Update summary
    document.getElementById('summaryTreatment').textContent = selectedTreatmentName;
    document.getElementById('summaryDoctor').textContent = selectedDoctorName;
    document.getElementById('summaryHospital').textContent = selectedHospitalName;
    document.getElementById('summaryRoom').textContent = selectedRoomName;
    document.getElementById('summaryDate').textContent = preferredDate.value || 'Not specified';
    document.getElementById('treatmentCostSummary').textContent = `₹${treatmentCost.toLocaleString()}`;
    document.getElementById('roomCostSummary').textContent = `₹${roomCostFor7Nights.toLocaleString()} (₹${roomCost.toLocaleString()}/night × 7 nights)`;
    document.getElementById('summaryCost').textContent = `₹${totalCost.toLocaleString()}`;
    document.getElementById('advanceAmount').textContent = `₹${advanceAmount.toFixed(2)}`;
    
    // Set hidden form fields
    document.getElementById('selectedTreatmentId').value = selectedTreatmentId;
    document.getElementById('selectedDoctorId').value = selectedDoctorId || '';
    document.getElementById('selectedHospitalId').value = selectedHospitalId;
    document.getElementById('selectedRoomId').value = selectedRoomId;
    document.getElementById('totalAmount').value = totalCost;
    
    showStep(5);
  });
  
  prevStep5.addEventListener('click', function() {
    showStep(4);
  });
  
  // Function to populate doctors based on treatment
  function populateDoctors(treatmentId) {
    // Clear current options
    doctorSelect.innerHTML = '<option value="">No preference (we\'ll recommend)</option>';
    
    // Show loading indicator
    doctorSelect.innerHTML += '<option value="">Loading doctors...</option>';
    doctorSelect.disabled = true;
    
    // Debug: Log the treatment ID
    console.log('Fetching doctors for treatment ID:', treatmentId);
    
    // Check if treatmentId is valid
    if (!treatmentId) {
      console.error('Invalid treatment ID provided to populateDoctors');
      doctorSelect.innerHTML = '<option value="">No preference (we\'ll recommend)</option>';
      doctorSelect.innerHTML += '<option value="">Error: No treatment selected</option>';
      doctorSelect.disabled = false;
      return;
    }
    
    // Make AJAX request to get doctors
    fetch(`/book/api/doctors/${treatmentId}/`)
      .then(response => {
        console.log('Doctor API response status:', response.status);
        // Check if response is OK
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        // Clear loading option
        doctorSelect.innerHTML = '<option value="">No preference (we\'ll recommend)</option>';
        doctorSelect.disabled = false;
        
        if (data.success) {
          // Check if doctors array exists and has data
          if (data.doctors && data.doctors.length > 0) {
            // Add doctors to select
            data.doctors.forEach(doctor => {
              const option = document.createElement('option');
              option.value = doctor.id;
              option.textContent = `Dr. ${doctor.name}`;
              doctorSelect.appendChild(option);
            });
          } else {
            doctorSelect.innerHTML += '<option value="">No doctors available for this treatment</option>';
          }
        } else {
          console.error('Error fetching doctors:', data.error);
          doctorSelect.innerHTML += '<option value="">Error: ' + data.error + '</option>';
        }
      })
      .catch(error => {
        console.error('Error fetching doctors:', error);
        doctorSelect.innerHTML = '<option value="">No preference (we\'ll recommend)</option>';
        doctorSelect.innerHTML += '<option value="">Error loading doctors: ' + error.message + '</option>';
        doctorSelect.disabled = false;
      });
  }
  
  // Function to populate hospitals based on treatment and doctor
  function populateHospitals(treatmentId, doctorId) {
    // Show loading indicator
    hospitalsList.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    // Debug: Log the parameters
    console.log('Fetching hospitals for treatment ID:', treatmentId, 'doctor ID:', doctorId);
    
    // Check if treatmentId is valid
    if (!treatmentId) {
      console.error('Invalid treatment ID provided to populateHospitals');
      hospitalsList.innerHTML = '<div class="col-12"><div class="alert alert-warning">Please select a treatment first</div></div>';
      nextStep3.disabled = true;
      return;
    }
    
    // Make AJAX request to get hospitals (only by treatment, not by doctor)
    let url = `/book/api/hospitals/${treatmentId}/`;
    
    fetch(url)
      .then(response => {
        console.log('Hospital API response status:', response.status);
        // Check if response is OK
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        hospitalsList.innerHTML = '';
        
        if (data.success && data.hospitals && data.hospitals.length > 0) {
          // Add hospitals to list
          data.hospitals.forEach(hospital => {
            const hospitalCard = document.createElement('div');
            hospitalCard.className = 'col-md-6';
            hospitalCard.innerHTML = `
              <div class="card hospital-card h-100" data-hospital-id="${hospital.id}" data-hospital-name="${hospital.name}" data-price="${hospital.starting_price}">
                <div class="position-relative">
                  <img src="https://picsum.photos/seed/h${hospital.id}/400/250" class="card-img-top" alt="${hospital.name}" style="height: 200px; object-fit: cover;">
                  ${hospital.is_takeopinion_choice ? '<span class="position-absolute top-0 end-0 badge bg-warning text-dark m-2">TO Choice</span>' : ''}
                </div>
                <div class="card-body">
                  <h5 class="card-title mb-1">${hospital.name}</h5>
                  <p class="card-text small text-muted mb-2">
                    <i class="bi bi-geo-alt me-1"></i>${hospital.city}${hospital.state ? ', ' + hospital.state : ''}${hospital.country ? ', ' + hospital.country : ''}
                  </p>
                  
                  <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      <span class="small">Rating</span>
                      <span class="fw-bold">${hospital.rating}/5.0</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                      <div class="progress-bar bg-warning" role="progressbar" style="width: ${hospital.rating * 20}%"></div>
                    </div>
                  </div>
                  
                  <div class="d-flex flex-wrap gap-1 mb-3">
                    ${hospital.jci_accredited ? '<span class="badge bg-info">JCI</span>' : ''}
                    ${hospital.nabh_accredited ? '<span class="badge bg-success">NABH</span>' : ''}
                    ${hospital.iso_certified ? '<span class="badge bg-secondary">ISO</span>' : ''}
                  </div>
                  
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <div class="small text-muted">Starting Price</div>
                      <div class="h5 text-primary mb-0">₹${parseFloat(hospital.starting_price).toLocaleString()}</div>
                    </div>
                    <span class="price-tag">₹${parseFloat(hospital.starting_price).toLocaleString()}</span>
                  </div>
                  
                  <div class="mt-2" id="hospital-price-info-${hospital.id}"></div>
                </div>
              </div>
            `;
            hospitalsList.appendChild(hospitalCard);
            
            // Add click event to select hospital
            hospitalCard.querySelector('.hospital-card').addEventListener('click', function() {
              // Remove selected class from all cards
              document.querySelectorAll('.hospital-card').forEach(card => {
                card.classList.remove('selected');
              });
              
              // Add selected class to clicked card
              this.classList.add('selected');
              
              // Store selected hospital data
              selectedHospitalId = this.dataset.hospitalId;
              selectedHospitalName = this.dataset.hospitalName;
              treatmentCost = parseFloat(this.dataset.price);
              
              // Update hidden form field immediately
              document.getElementById('selectedHospitalId').value = selectedHospitalId;
              
              // Enable next button
              nextStep3.disabled = false;
              
              // Get doctor pricing if doctor is selected
              if (selectedDoctorId) {
                getDoctorPricing(selectedDoctorId, selectedTreatmentId, selectedHospitalId);
              }
            });
          });
        } else {
          hospitalsList.innerHTML = '<div class="col-12"><div class="alert alert-info">No hospitals found for this treatment. Please try another treatment or contact support.</div></div>';
          nextStep3.disabled = true;
        }
      })
      .catch(error => {
        console.error('Error fetching hospitals:', error);
        hospitalsList.innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading hospitals: ' + error.message + '</div></div>';
        nextStep3.disabled = true;
      });
  }
  
  // Function to populate room options based on hospital
  function populateRoomOptions(hospitalId) {
    // Show loading indicator
    roomOptions.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    // Debug: Log the hospital ID
    console.log('Fetching rooms for hospital ID:', hospitalId);
    
    // Check if hospitalId is valid
    if (!hospitalId) {
      console.error('Invalid hospital ID provided to populateRoomOptions');
      roomOptions.innerHTML = '<div class="col-12"><div class="alert alert-warning">Please select a hospital first</div></div>';
      nextStep4.disabled = true;
      return;
    }
    
    // Make AJAX request to get room options
    fetch(`/book/api/rooms/${hospitalId}/`)
      .then(response => {
        console.log('Room API response status:', response.status);
        // Check if response is OK
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        roomOptions.innerHTML = '';
        
        if (data.success && data.rooms && data.rooms.length > 0) {
          // Add rooms to list
          data.rooms.forEach(room => {
            const roomOption = document.createElement('div');
            roomOption.className = 'col-md-6';
            roomOption.innerHTML = `
              <div class="card room-option h-100" data-room-id="${room.id}" data-room-name="${room.name}" data-price="${room.price_per_night}">
                <div class="position-relative">
                  <img src="https://picsum.photos/seed/r${room.id}/400/250" class="card-img-top" alt="${room.name}" style="height: 150px; object-fit: cover;">
                </div>
                <div class="card-body">
                  <h5 class="card-title mb-1">${room.name}</h5>
                  <p class="card-text small text-muted mb-2">
                    <i class="bi bi-geo-alt me-1"></i>${room.address}
                  </p>
                  
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                      <div class="small text-muted">Price per night</div>
                      <div class="h5 text-primary mb-0">₹${parseFloat(room.price_per_night).toLocaleString()}</div>
                    </div>
                    <span class="price-tag">₹${parseFloat(room.price_per_night).toLocaleString()}/night</span>
                  </div>
                  
                  <ul class="list-unstyled small mb-0">
                    <li class="mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i>24/7 Room Service</li>
                    <li class="mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i>Free Wi-Fi</li>
                    <li class="mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i>Air Conditioning</li>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i>Television</li>
                  </ul>
                </div>
              </div>
            `;
            roomOptions.appendChild(roomOption);
            
            // Add click event to select room
            roomOption.querySelector('.room-option').addEventListener('click', function() {
              // Remove selected class from all options
              document.querySelectorAll('.room-option').forEach(option => {
                option.classList.remove('selected');
              });
              
              // Add selected class to clicked option
              this.classList.add('selected');
              
              // Store selected room data
              selectedRoomId = this.dataset.roomId;
              selectedRoomName = this.dataset.roomName;
              roomCost = parseFloat(this.dataset.price);
              
              // Update hidden form field immediately
              document.getElementById('selectedRoomId').value = selectedRoomId;
              
              // Enable next button
              nextStep4.disabled = false;
            });
          });
        } else {
          roomOptions.innerHTML = '<div class="col-12"><div class="alert alert-info">No room options available for this hospital.</div></div>';
          nextStep4.disabled = true;
        }
      })
      .catch(error => {
        console.error('Error fetching rooms:', error);
        roomOptions.innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading room options: ' + error.message + '</div></div>';
        nextStep4.disabled = true;
      });
  }
  
  // Function to get treatment pricing information
  function getTreatmentPricing(treatmentId) {
    // Debug: Log the treatment ID
    console.log('Fetching treatment pricing for treatment ID:', treatmentId);
    
    // Check if treatmentId is valid
    if (!treatmentId) {
      console.error('Invalid treatment ID provided to getTreatmentPricing');
      return;
    }
    
    fetch(`/book/api/treatment-pricing/${treatmentId}/`)
      .then(response => {
        console.log('Treatment pricing API response status:', response.status);
        // Check if response is OK
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          console.log('Treatment pricing:', data);
          // You can display this information in the UI if needed
        }
      })
      .catch(error => {
        console.error('Error fetching treatment pricing:', error);
      });
  }
  
  // Function to get doctor pricing information
  function getDoctorPricing(doctorId, treatmentId, hospitalId) {
    // Debug: Log the parameters
    console.log('Fetching doctor pricing for doctor ID:', doctorId, 'treatment ID:', treatmentId, 'hospital ID:', hospitalId);
    
    // Check if all parameters are valid
    if (!doctorId || !treatmentId || !hospitalId) {
      console.error('Invalid parameters provided to getDoctorPricing', {doctorId, treatmentId, hospitalId});
      return;
    }
    
    fetch(`/book/api/doctor-pricing/${doctorId}/${treatmentId}/${hospitalId}/`)
      .then(response => {
        console.log('Doctor pricing API response status:', response.status);
        // Check if response is OK
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          // Display pricing information
          const priceInfoElement = document.getElementById(`hospital-price-info-${hospitalId}`);
          if (priceInfoElement) {
            priceInfoElement.innerHTML = `
              <div class="alert alert-info small mb-0">
                <i class="bi bi-info-circle me-1"></i>
                ${data.message}
              </div>
            `;
          }
          
          // Update the treatment cost if this is the selected hospital
          if (selectedHospitalId == hospitalId) {
            treatmentCost = data.price;
            if (document.getElementById('treatmentCost')) {
              document.getElementById('treatmentCost').textContent = `₹${treatmentCost.toLocaleString()}`;
            }
          }
        }
      })
      .catch(error => {
        console.error('Error fetching doctor pricing:', error);
      });
  }
  

</script>
{% endblock %}